$(function(){function u(){var a=this.files[0];if(!/image\/\w+/.test(a.type))return alert("请确保文件类型"),!1;var b=new FileReader;b.readAsDataURL(a),b.onload=function(a){h=new Image,h.src=this.result,h.onload=function(){q=0,r=0,k=0,l=0,h.height>h.width?(h.height*=t/h.width,h.width=t,r=l=(s-h.height)/2,j=!0):(h.width*=s/h.height,h.height=s,q=k=(t-h.width)/2,j=!1),0==g?(i=new Image,i.setAttribute("crossOrigin","anonymous"),i.src="../img/20170429143008.png?v=12",i.onload=function(){f.drawImage(i,0,0,t,s),v(),g++}):(v(),g++)}}}function v(){c.clearRect(0,0,t,s),c.drawImage(h,q,r,h.width,h.height),console.log(m+" "+n),console.log(o+" "+p),console.log(q+" "+r)}function w(){c.clearRect(0,0,t,s),f.clearRect(0,0,t,s),c.drawImage(h,q,r,h.width,h.height),c.drawImage(i,0,0,t,s)}function x(){w();var a=document.createElement("a");a.href=b.toDataURL("image/png"),a.download="RX500_pic"+(new Date).getTime()+".png",a.click()}function y(a){if(w(),a.preventDefault(),window.BlobBuilder=window.BlobBuilder||window.MSBlobBuilder||window.WebKitBlobBuilder||window.MozBlobBuilder,b.toBlob=b.toBlob||b.msToBlob,window.navigator.saveBlob=window.navigator.saveBlob||window.navigator.msSaveBlob,window.BlobBuilder&&b.toBlob&&window.navigator.saveBlob){var c="RX500_pic"+(new Date).getTime()+".png",d=new BlobBuilder;d.append(b.toBlob()),window.navigator.saveBlob(d.getBlob(),c)}}function z(a){var c,d,e,f,g,b=navigator.userAgent.toLowerCase();"ActiveXObject"in self?(f=(e=b.match(/msie ([\d.]+)/))?e[1]:(e=b.match(/rv:([\d.]+)/))?e[1]:0,c={"trident/7.0":11,"trident/6.0":10,"trident/5.0":9,"trident/4.0":8},d=(e=b.match(/(trident\/[\d.]+|edge\/[\d.]+)/))?e[1]:void 0,g=(c[d]||f)>0?"ie":void 0):g=(e=b.match(/edge\/([\d.]+)/))?"ie":(e=b.match(/firefox\/([\d.]+)/))?"firefox":(e=b.match(/chrome\/([\d.]+)/))?"chrome":(e=b.match(/opera.([\d.]+)/))?"opera":(e=b.match(/version\/([\d.]+).*safari/))?"safari":void 0;var h;return h=d&&c[d]?c[d]:e[1],void 0!=a?g+"/"+h:g}var h,i,j,k,l,m,n,o,p,q,r,a=$("#uploadPhoto"),b=$("#makePhotoCanvas")[0],c=b.getContext("2d"),d=$("#downLoadImg"),e=$("#upper")[0],f=e.getContext("2d"),g=0;const s=b.height,t=b.width;a.change(u),d.click("ie"==z()?y:x),$(e).on("mousedown",function(a){g>0&&(m=a.clientX,n=a.clientY,k=q,l=r,$("body").on("mousemove",function(a){o=a.clientX,p=a.clientY,q=1==j?q:q=-(m-o)+k<=t-h.width?t-h.width:-(m-o)+k>=0?0:-(m-o)+k,r=1==j?r=-(n-p)+l<=s-h.height?s-h.height:-(n-p)+l>=0?0:-(n-p)+l:r,v()}),$("body").one("mouseup",function(a){$("body").off("mousemove")}))})});